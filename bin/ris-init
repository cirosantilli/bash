#!/usr/bin/env bash

#! dependencies=["./find-music",]

#------------------------------------------------------------
#
# Ciro D. Santilli 
#
# Relative path
# Inode
# Sha1 sum
# --------
# RIS
#
# RIS
#
# RIS
# 
#------------------------------------------------------------

set -u # error on undefined variable
set -e # stop execution if one command goes wrong

usage()
{
  echo 'ris-init root ... ' 1>&2
}

# default vals
FILE_OUTPUT=false
OPATH="all.ris"

while getopts ao:r OPT; do
  case "$OPT" in
    h)
      usage
      exit 0
      ;;
    o)
      OPATH=$OPTARG
      FILE_OUTPUT=true
      ;;
    \?)
      usage
      exit 1
      ;;
  esac
done

shift `expr $OPTIND - 1`

# ensure at least one param left
if [ $# -eq 0 ]; then
  usage
  exit 1
fi

for ROOT in "$@"; do
  
  OPUT=""
  while IFS= read -r -u3 -d $'\0' FILE; do
    OPUT="$OPUT""$FILE"$'\n'
    OPUT="$OPUT""$(inode-get "$FILE")"$'\n'
    OPUT="$OPUT""$(sha1sum-get "$FILE")"$'\n'$'\n'
  done 3< <(find "$ROOT" -type f -print0)

  if $FILE_OUTPUT; then
    echo "$OPUT" > "$OPATH"
  else
    echo -n "$OPUT" 
  fi 

done

exit 0
